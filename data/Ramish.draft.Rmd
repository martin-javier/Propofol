---
title: "F.P.P"
author: "Raseen Ramish"
date: "2024-11-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Packages:

```{r}
library(data.table)
library(tidyr)
library(ggplot2)
library(dplyr)
library(patchwork)
library(wesanderson)
library("viridis")
library(survival)
```

#### Datensatz:
```{r}
mergedAndCleanedData <- readRDS("F:/5.semester/FPP/Propofol/data/mergedAndCleanedData.Rds")
patient <- readRDS("F:/5.semester/FPP/Propofol/data/patient.Rds")
daily <- readRDS("F:/5.semester/FPP/Propofol/data/daily.Rds")
ICU <- readRDS("F:/5.semester/FPP/Propofol/data/ICU.Rds")
daily_all <- readRDS("F:/5.semester/FPP/Propofol/data/daily_all.Rds")
```

#### Datensatz in data.table format:
```{r}
mergedAndCleanedData.tbl <- copy(as.data.table(mergedAndCleanedData))
patient.tbl <- copy(as.data.table(patient))
ICU.tbl <- copy(as.data.table(ICU))
daily_all.tbl <- copy(as.data.table(daily_all))


```


#### Struktur von Patient Datasatz:
```{r}
str(patient.tbl)
```

#### Struktur von daily_all Datasatz:

```{r}
str(daily_all.tbl)
```


#### Gemeinsame Variablenamens :

```{r}
names(daily_all.tbl)[ (names(daily_all.tbl) %in% names(patient.tbl))]
```

#### alle Variable die "2_4" enthalten, sind nicht relevant und die werden gelöcht.

```{r}
patient.tbl[, grep("2_4", names(patient.tbl), value = TRUE) := NULL]
```


#### Gleichen wir die Type von Variabletype in beiden Datensatz
```{r}
daily_all.tbl[, `:=`(Year = as.factor(Year),
                     CombinedicuID = as.factor(CombinedicuID),
                     Propofol = as.factor(Propofol)) ]
```

#### Merged Datensatz von Ptient und daily_all

```{r}
mergedPatientAndDaily <-  patient.tbl[daily_all.tbl, on = c("CombinedID", "Year"), nomatch = 0]
mergedPatientAndDaily

```


#### Von Datensatz daily_all  sind nur die Patienten für die Analyse nützlich, die 
über 18 Jahre ALt sind und einen Aufenthaltsdauer von mindestens siebe Tagan in ICU haben. darüber hinaus die haben in ersten sieben Tagen ihren Aufenthalt in ICU Propofol genomen.


```{r}
cleanedMergedPatientAndDaily <- mergedPatientAndDaily[Age > 18 & BMI > 13 & DaysInICU >= 7 & Study_Day <= 7, ][, c("i.CombinedicuID", "Morning_BS") := NULL ]
cleanedMergedPatientAndDaily
```




## Grafical Analysis von der wichtigsten Variablen:

```{r}
allgemineTheme <-theme_bw()+
  theme(plot.margin = unit(c(t = 0.25,r= 0.3, b = 0.25, l = 0.25), "in"),
        axis.text = element_text(size = 15),
        axis.title.x =  element_text(size = 15),
        axis.title.y =  element_text(size = 15),
        legend.text = element_text(size=13),
        legend.title = element_text(size = 13))+
  theme(axis.title.x = element_text(margin = margin(t = 0.25, unit = "in")),
        axis.title.y = element_text(margin = margin(r = 0.25, unit = "in")))
```

#### Die Patienten sind wichtig die über 60 jahre Alt sind:
```{r}
cleanedMergedPatientAndDaily[Age > 65, .(Age, Gender)] %>%  
  ggplot(aes(Age, fill = factor(Gender))) + 
  geom_bar(position = "fill") + 
  allgemineTheme +
  labs(x = "Alter",
       y = "Häufigkeit") +
  scale_fill_viridis_d( name = "Gender",
                        begin = 0.1, end = 0.9,
                        guide = guide_legend(reverse = FALSE)
                        ,option = "turbo")
```

#### die Bewertung der Schwere der Krankheitszustand:

```{r}
cleanedMergedPatientAndDaily[Age > 65, .(ApacheIIScore)] %>% 
  ggplot(aes(ApacheIIScore)) + 
  geom_bar(fill = "Blue") +
  allgemineTheme +
  labs(x = "ApacheIIScore",
       y = "Häufigkeit") +
  scale_fill_viridis_d( 
                        begin = 0.1, end = 0.9,
                        guide = guide_legend(reverse = TRUE)
                        ,option = "turbo") +
  geom_vline(xintercept = 22,
             color = "red", linetype = "dashed", linewidth = 1) 
  

```

#### welche Diagnose war Häufig unter der Patienten:

```{r}
cleanedMergedPatientAndDaily[Age > 18, .(DiagID2, Age)] %>% 
  ggplot(aes(DiagID2, fill = factor(DiagID2))) + 
  geom_bar() +
  allgemineTheme +
  labs(x = "Diagnose",
       y = "Häufigkeit") +
  scale_fill_viridis_d(begin = 0.1, end = 0.9,
                        guide = guide_legend(reverse = TRUE),
                        option = "turbo") + 
  theme(legend.position = "none") +
  coord_flip()
```

#### Wie viele Propofol hat jede Pateint bekommen.

```{r}
cleanedMergedPatientAndDaily[Age > 18 & BMI > 13 & PropofolCal > 0, .(totla.propofol = sum(PropofolCal), Gender = unique(Gender), Age = unique(Age)), by = CombinedID]
```


#### Anzahl Männer, die über 18 Alt sind, und die wurden propofol verabreicht.

```{r}
MännerAnteil <- cleanedMergedPatientAndDaily[Age > 18 & BMI > 13 & Gender == "Male" & PropofolCal > 0, 
                .(total.propofol = sum(PropofolCal),
                            Gender = unique(Gender),
                            Age = unique(Age), 
                  PatientDied = unique(PatientDied), 
                  DiagID2 = unique(DiagID2)), by = CombinedID]
MännerAnteil
```
#### Häufigkeit der Krankheit unter Männer:

```{r}
MännerAnteil[, .(DiagID2, Age)] %>% 
  ggplot(aes(DiagID2, fill = factor(DiagID2))) + 
  geom_bar() +
  allgemineTheme +
  labs(x = "Diagnose",
       y = "Häufigkeit") +
  scale_fill_viridis_d(begin = 0.1, end = 0.9,
                        guide = guide_legend(reverse = TRUE),
                        option = "turbo") + 
  theme(legend.position = "none") +
  coord_flip()
```



#### Anzahl Frauen, die über 18 Alt sind, und die wurden propofol verabreicht.

```{r}
FrauenAnteil <- cleanedMergedPatientAndDaily[Age > 18 & BMI > 13 & Gender == "Female" & PropofolCal > 0, 
                .(total.propofol = sum(PropofolCal ),
                            Gender = unique(Gender),
                            Age = unique(Age),
                  PatientDied = unique(PatientDied),
                  DiagID2 = unique(DiagID2)), by = CombinedID]
FrauenAnteil
```
#### Häufigkeit der Krankheit unter Frauen:

```{r}
FrauenAnteil[, .(DiagID2, Age)] %>% 
  ggplot(aes(DiagID2, fill = factor(DiagID2))) + 
  geom_bar() +
  allgemineTheme +
  labs(x = "Diagnose",
       y = "Häufigkeit") +
  scale_fill_viridis_d(begin = 0.1, end = 0.9,
                        option = "turbo") + 
  theme(legend.position = "none") +
  coord_flip()
```


#### Anzahl verstorben vs nicht verstorben unter Frauen:

```{r}
FrauenAnteil[, {
  count = .N
  totlLength = length(unique(FrauenAnteil$CombinedID))
  proportion = count / totlLength
}, by = PatientDied] %>% ggplot(aes(x = 1, y = V1, fill = factor(V1, labels = c("Verstorben", "Leben")))) +
  geom_bar(stat = "identity") +
  allgemineTheme +
  labs(x = "",
       y = "") +
  scale_fill_viridis_d(name = "Anteil\n verstorbene VS lebende Frauen",
    begin = 0.9, end = 0.1,
                        option = "turbo")

```

#### Anzahl verstorben vs nicht verstorben unter Männer:


```{r}
MännerAnteil[, {
  count = .N
  totlLength = length(unique(FrauenAnteil$CombinedID))
  proportion = count / totlLength
}, by = PatientDied] %>% ggplot(aes(x = 1, y = V1, fill = factor(V1, labels = c("Verstorben", "Leben")))) +
  geom_bar(stat = "identity") +
  allgemineTheme +
  labs(x = "",
       y = "") +
  scale_fill_viridis_d(name = "Anteil\n verstorbene VS lebende Männer",
    begin = 0.9, end = 0.1,
                        option = "turbo")

```



s
############################ nicht mehr relevant. 

#### cox Proportional Hazard Model:

```{r}
attach(data)
coxMod <- coxph(Surv(Surv0To60, PatientDied) ~ Age + BMI + ApacheIIScore + PropofolCal)
summary(coxMod )
```

#### Kaplan Meier Model:

```{r}
attach(data)
kmModel <- survfit(Surv(Surv0To60, PatientDied) ~ Propofol)
kmModel
plot(kmModel, conf.int = F, xlab = "Time (smoth)", ylab = "%Alive = S(t)", main = "KM")
```

